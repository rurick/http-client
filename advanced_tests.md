# Набор продвинутых тестов HTTP клиента

Этот документ описывает комплексный набор тестов, созданный для проверки сложных сценариев, граничных случаев и проблем с конкурентностью в библиотеке HTTP клиента.

## Обзор

Набор тестов состоит из двух основных файлов:
- `tests/integration/advanced_integration_test.go` - Сложные интеграционные тесты 
- `advanced_edge_case_test.go` - Модульные тесты для граничных случаев и обработки ошибок

## Покрытие тестами

### 1. Интеграция Circuit Breaker + Retry

**TestRetryWithOpenCircuitBreaker**
- Тестирует взаимодействие между логикой повторов и circuit breaker
- Проверяет, что когда circuit breaker открывается во время повтора, последующие повторы прерываются
- Валидирует, что обращения к серверу ограничиваются открытием circuit breaker

**TestCircuitBreakerResetsAfterSuccessfulRetry** 
- Тестирует переходы circuit breaker при восстановлении сервиса
- Проверяет, что circuit корректно переходит через состояния Open → Half-Open → Closed
- Убеждается, что успешные запросы сбрасывают состояние circuit breaker

**TestRetryWithCircuitBreakerRecovery**
- Сложный сценарий, где circuit breaker открывается, затем сервис восстанавливается
- Тестирует чувствительные к времени переходы состояний в реалистичных паттернах отказов

### 2. Валидация Backoff и Jitter

**TestBackoffWithJitter**
- Проверяет, что задержки повторов включают случайный jitter как ожидается
- Тестирует, что задержки варьируются в ожидаемом диапазоне: `[baseDelay * (1-jitter), baseDelay * (1+jitter)]`
- Валидирует, что jitter действительно варьируется по нескольким выборкам

### 3. Граничные случаи идемпотентных запросов

**TestIdempotentRetryWithUnreadableBody**
- Тестирует POST запросы с `Idempotency-Key`, но с невосстанавливаемым телом (io.Pipe)
- Проверяет, что повторы не выполняются, когда тело запроса не может быть перечитано
- Валидирует поведение единственной попытки для нечитаемых тел

**TestIdempotentRetryWithBodyReadErrorOnSecondAttempt**
- Тестирует сценарий, где тело может быть прочитано один раз, но выдает ошибку при повторе
- Проверяет правильную обработку ошибок, когда чтение тела не удается во время подготовки повтора

### 4. Сценарии с таймаутами

**TestOverallTimeoutDuringRetry**
- Тестирует, что общий таймаут клиента истекает во время последовательности повторов
- Проверяет, что таймаут соблюдается даже в пределах лимита MaxAttempts
- Валидирует, что не все повторы выполняются при наступлении таймаута

**TestPerTryTimeoutAndRetry**
- Тестирует, что таймауты на попытку корректно работают с множественными повторными попытками
- Проверяет, что таймауты на отдельных попытках запускают повторы
- Обеспечивает успех финальной попытки при соблюдении временных ограничений

### 5. Конкурентность и потокобезопасность

**TestConcurrentClientUsageWithSharedConfig**
- Тестирует потокобезопасность при использовании одного экземпляра клиента несколькими горутинами
- Валидирует успешное завершение 50 конкурентных запросов
- Проверяет отсутствие состояний гонки при доступе к конфигурации клиента

**TestConcurrentCircuitBreakerStateChanges**
- Тестирует переходы состояний circuit breaker при высокой конкурентности (100 горутин)
- Валидирует потокобезопасное управление состоянием без состояний гонки
- Обеспечивает корректное ограничение запросов circuit breaker под нагрузкой

### 6. Метрики и наблюдаемость

**TestMetricsOnRetryWithContextCancellation**
- Тестирует запись метрик при отмене контекста во время backoff повтора
- Проверяет корректную запись метрик повторов до отмены
- Валидирует правильную очистку gauge'ей выполняющихся запросов

**TestMetricsLabelsForDifferentHosts**
- Тестирует корректное заполнение меток хостов в метриках для разных доменов
- Валидирует сбор метрик для нескольких целевых хостов

### 7. Граничные случаи обработки ошибок

**TestClientHandlesResponseBodyReadError**
- Тестирует обработку ошибок, когда тело ответа сервера становится нечитаемым
- Симулирует разрыв соединения во время чтения ответа
- Валидирует соответствующее распространение сетевых ошибок

### 8. Модульные тесты для типов ошибок

Набор тестов также включает комплексные модульные тесты для всех пользовательских типов ошибок:

- **HTTPError** - Ошибки HTTP ответов с метаданными
- **MaxAttemptsExceededError** - Исчерпание повторов с контекстом
- **TimeoutExceededError** - Нарушения таймаута
- **ConfigurationError** - Ошибки валидации конфигурации
- **RetryableError** интерфейс - Классификация повторяемых vs неповторяемых ошибок

### 9. Тесты служебных функций

- Вычисление размера запроса/ответа
- Извлечение хоста для метрик
- Клонирование тела запроса
- Классификация сетевых ошибок
- Очистка ресурсов клиента

## Ключевые находки

### Обнаруженные состояния гонки ⚠️
Тесты успешно обнаружили **критические состояния гонки** в реализации circuit breaker:

1. **Поле `lastFailResponse`** - Несколько горутин конкурентно читают/пишут это поле без синхронизации
2. **Клонирование тела ответа** - Метод `cloneHttpResponse` читает тела ответов конкурентно
3. **Переходы состояний circuit breaker** - Изменения состояний и доступ к полям требуют лучшей синхронизации

Это реальные проблемы потокобезопасности, которые следует решить в продакшн коде.

### Обработка тела запроса
Текущая реализация обрабатывает повтор тела запроса, читая все тело в память заранее. Для невосстанавливаемых тел (таких как pipes), выполняется только одна попытка, что является корректным поведением.

### Поведение Circuit Breaker
Circuit breaker корректно интегрируется с логикой повторов, прерывая повторы при открытом состоянии и правильно переходя между состояниями на основе паттернов успеха/неудачи.

### Обработка таймаутов
Реализация корректно обрабатывает как общие таймауты, так и таймауты на попытку, с правильной отменой контекста и очисткой.

## Запуск тестов

### Интеграционные тесты (с build tag)
```bash
go test -v -race -tags=integration ./tests/integration/ -timeout 60s
```

### Модульные тесты
```bash
go test -v -race . -run "TestAdvanced|TestHTTPError|TestMaxAttempts|TestTimeout|TestRetryable" -timeout 30s
```

### Все тесты
```bash
go test -v -race . -timeout 60s
```

## Философия тестирования

Эти тесты следуют нескольким важным принципам:

1. **Реальные сценарии** - Тесты симулируют фактические паттерны отказов и граничные случаи
2. **Фокус на конкурентности** - Обширное тестирование потокобезопасности и состояний гонки
3. **Чувствительность ко времени** - Тесты валидируют поведение таймаутов и задержек
4. **Распространение ошибок** - Комплексное тестирование путей обработки ошибок
5. **Валидация интеграции** - Тесты взаимодействий компонентов, а не только изолированных единиц

## Рекомендации

На основе результатов тестов рекомендуются следующие улучшения:

1. **Исправить состояние гонки Circuit Breaker** - Добавить правильную синхронизацию для поля `lastFailResponse`
2. **Добавить ограничения размера тела запроса** - Предотвратить исчерпание памяти от больших тел запросов
3. **Улучшить сообщения об ошибках** - Сделать сообщения об ошибках более описательными для отладки
4. **Добавить валидацию метрик** - Включить фактическую проверку метрик в интеграционные тесты
5. **Рассмотреть стриминг тела запроса** - Для больших тел избегать чтения всего содержимого в память

Набор тестов успешно валидирует устойчивость библиотеки в сложных сценариях и обеспечивает уверенность для использования в продакшне в высоконагруженных, конкурентных средах.
